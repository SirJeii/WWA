<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Quiz Creator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Import Firebase JS SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, addDoc, collection, getDocs, deleteDoc, updateDoc, query, where } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        // --- Your web app's Firebase configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyDdPi75Cfl92SxsdHP1ZdoFEDgDDJWygng",
            authDomain: "name-spinner-app.firebaseapp.com",
            projectId: "name-spinner-app",
            storageBucket: "name-spinner-app.firebasestorage.app",
            messagingSenderId: "663136681592",
            appId: "1:663136681592:web:06618739cbaaa2dfb9b78d"
        };
        // --- END OF FIREBASE CONFIGURATION ---

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Make auth and db globally available for our script
        window.firebaseServices = { auth, db, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, doc, setDoc, getDoc, addDoc, collection, getDocs, deleteDoc, updateDoc, query, where };
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; }
        .hidden { display: none !important; }
        .number-box.visited { background-color: #6b7280 !important; cursor: default; transform: scale(0.95); }
        .number-box.visited:hover { transform: scale(0.95); box-shadow: none; }
        .random-active { transform: scale(1.15) !important; box-shadow: 0 8px 25px rgba(0,0,0,0.3) !important; border-color: #fff; border-width: 2px; }
        #confetti-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; overflow: hidden; z-index: 9999; }
        .confetti { position: absolute; width: 10px; height: 10px; opacity: 0.7; animation: fall 5s linear forwards; }
        @keyframes fall { to { transform: translateY(100vh) rotate(360deg); opacity: 0; } }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .option-radio:checked + label { background-color: #3b82f6; color: white; }
        
        /* Custom scrollbar for question container */
        #questions-container::-webkit-scrollbar { width: 8px; }
        #questions-container::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        #questions-container::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 4px; }
        #questions-container::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-90 flex flex-col items-center justify-center z-[10000] hidden">
        <div class="loader mb-4"></div>
        <p id="loading-text" class="text-xl font-semibold text-gray-700 animate-pulse">Loading...</p>
    </div>

    <!-- Auth Page -->
    <div id="auth-page" class="min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-blue-500 to-indigo-600">
        <div class="w-full max-w-md bg-white p-8 rounded-2xl shadow-2xl">
            <div class="flex justify-center mb-4">
                <i data-lucide="brain-circuit" class="w-16 h-16 text-blue-600"></i>
            </div>
            <h1 class="text-4xl font-bold text-center text-gray-800 mb-2">Quiz Master AI</h1>
            <p class="text-center text-gray-500 mb-8">Create quizzes from PDFs in seconds</p>
            
            <div id="auth-container">
                <!-- Login Form -->
                <form id="login-form" class="space-y-4">
                    <input type="email" id="login-email" placeholder="Email" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition" required>
                    <input type="password" id="login-password" placeholder="Password" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition" required>
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow-lg hover:shadow-xl transition transform hover:-translate-y-0.5">Login</button>
                    <p class="text-center text-sm text-gray-600 mt-4">Don't have an account? <a href="#" id="show-signup" class="text-blue-600 hover:underline font-semibold">Sign up</a></p>
                </form>
                <!-- Signup Form -->
                <form id="signup-form" class="space-y-4 hidden">
                    <input type="email" id="signup-email" placeholder="Email" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none transition" required>
                    <input type="password" id="signup-password" placeholder="Password" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none transition" required>
                    <button type="submit" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded-lg shadow-lg hover:shadow-xl transition transform hover:-translate-y-0.5">Create Account</button>
                    <p class="text-center text-sm text-gray-600 mt-4">Already have an account? <a href="#" id="show-login" class="text-purple-600 hover:underline font-semibold">Login</a></p>
                </form>
            </div>
            <p id="auth-error" class="text-red-500 text-center mt-4 text-sm font-medium"></p>
        </div>
    </div>

    <!-- Dashboard Page -->
    <div id="dashboard-page" class="hidden min-h-screen bg-gray-50">
        <nav class="bg-white shadow-sm sticky top-0 z-50">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16 items-center">
                    <div class="flex items-center gap-2">
                        <i data-lucide="brain-circuit" class="w-8 h-8 text-blue-600"></i>
                        <h1 class="text-2xl font-bold text-gray-800">Quiz Master</h1>
                    </div>
                    <button id="logout-btn" class="text-gray-600 hover:text-red-600 font-medium transition flex items-center gap-2">
                        <i data-lucide="log-out" class="w-5 h-5"></i> Logout
                    </button>
                </div>
            </div>
        </nav>

        <div class="max-w-7xl mx-auto p-6">
            <div class="flex justify-between items-center mb-8 mt-4">
                <h2 class="text-3xl font-bold text-gray-800">My Quizzes</h2>
                <button id="create-new-quiz-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:shadow-green-200 transition flex items-center gap-2">
                    <i data-lucide="plus-circle" class="w-5 h-5"></i> Create New Quiz
                </button>
            </div>
            
            <div id="quiz-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Quiz cards will be injected here -->
            </div>
             <div id="no-quizzes-message" class="text-center py-20 hidden">
                <div class="bg-white p-8 rounded-full inline-block mb-4 shadow-sm">
                    <i data-lucide="folder-open" class="w-16 h-16 text-gray-300"></i>
                </div>
                <h3 class="text-xl font-medium text-gray-600 mb-2">No quizzes yet</h3>
                <p class="text-gray-400">Create your first quiz manually or using AI!</p>
             </div>
        </div>
    </div>

    <!-- Creation Page -->
    <div id="creation-page" class="hidden min-h-screen flex flex-col bg-gray-100">
        <div class="bg-white shadow sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
                <div class="flex items-center gap-4 overflow-hidden">
                    <button id="back-to-dashboard-btn" class="text-gray-500 hover:text-gray-800 transition">
                        <i data-lucide="arrow-left" class="w-6 h-6"></i>
                    </button>
                    <h1 id="creation-title" class="text-2xl font-bold text-gray-800 truncate">Create Your Quiz</h1>
                </div>
                <div class="flex gap-3">
                    <button id="save-quiz-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg shadow transition flex items-center gap-2">
                        <i data-lucide="save" class="w-5 h-5"></i> Save
                    </button>
                </div>
            </div>
        </div>

        <div class="flex-grow p-6 overflow-y-auto">
            <div class="max-w-4xl mx-auto space-y-6">
                
                <!-- Import Section -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                    <h3 class="font-semibold text-lg mb-4 text-gray-700 flex items-center gap-2">
                        <i data-lucide="upload-cloud" class="w-5 h-5 text-blue-500"></i> Import Content
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <button id="import-pdf-btn" class="group relative flex flex-col items-center justify-center p-6 border-2 border-dashed border-blue-300 rounded-lg hover:bg-blue-50 hover:border-blue-500 transition cursor-pointer">
                            <i data-lucide="file-text" class="w-8 h-8 text-blue-500 mb-2 group-hover:scale-110 transition"></i>
                            <span class="font-bold text-blue-600">Generate from PDF(s)</span>
                            <span class="text-xs text-blue-400 mt-1">AI-Powered â€¢ Multiple files</span>
                            <span class="absolute top-2 right-2 bg-gradient-to-r from-pink-500 to-violet-500 text-white text-[10px] px-2 py-0.5 rounded-full font-bold">NEW</span>
                        </button>
                        
                        <button id="import-identification-btn" class="flex flex-col items-center justify-center p-6 border-2 border-dashed border-gray-300 rounded-lg hover:bg-gray-50 hover:border-purple-500 transition">
                            <i data-lucide="table" class="w-8 h-8 text-gray-400 mb-2"></i>
                            <span class="font-medium text-gray-600">CSV Identification</span>
                        </button>

                        <button id="import-multiple-choice-btn" class="flex flex-col items-center justify-center p-6 border-2 border-dashed border-gray-300 rounded-lg hover:bg-gray-50 hover:border-indigo-500 transition">
                            <i data-lucide="list-checks" class="w-8 h-8 text-gray-400 mb-2"></i>
                            <span class="font-medium text-gray-600">CSV Multiple Choice</span>
                        </button>
                    </div>
                    <div class="mt-2 text-right">
                         <button id="format-info-btn" class="text-sm text-blue-500 hover:text-blue-700 underline">View CSV Formats</button>
                    </div>
                    <input type="file" id="file-upload-input" class="hidden" accept=".csv">
                    <input type="file" id="pdf-upload-input" class="hidden" accept="application/pdf" multiple>
                </div>

                <!-- Questions List -->
                <div id="questions-container" class="space-y-6">
                    <div id="empty-state-message" class="text-center py-12 bg-white rounded-xl border border-gray-200 border-dashed">
                        <div class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-gray-100 mb-3">
                            <i data-lucide="plus" class="w-6 h-6 text-gray-400"></i>
                        </div>
                        <p class="text-gray-500 font-medium">No questions yet.</p>
                        <p class="text-gray-400 text-sm mb-4">Upload a file or add manually.</p>
                        <button id="add-question-btn-empty" class="text-blue-600 font-semibold hover:underline">Add First Question</button>
                    </div>
                </div>

                <!-- Bottom Action -->
                <div class="flex justify-center pt-4 pb-12">
                    <button id="add-question-btn" class="bg-gray-800 hover:bg-gray-900 text-white font-bold py-3 px-8 rounded-full shadow-lg transform transition hover:scale-105 flex items-center gap-2">
                        <i data-lucide="plus" class="w-5 h-5"></i> Add Manual Question
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Game Page -->
    <div id="game-page" class="hidden min-h-screen bg-slate-900 text-white overflow-hidden relative">
        <div id="confetti-container"></div>
        
        <!-- Game Header -->
        <div class="absolute top-0 left-0 w-full p-4 flex justify-between items-center z-10 bg-slate-900 bg-opacity-90 backdrop-blur-sm">
            <button id="game-back-to-dashboard-btn" class="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-lg transition flex items-center gap-2">
                <i data-lucide="arrow-left" class="w-4 h-4"></i> Exit
            </button>
            <h1 id="game-title" class="text-xl md:text-3xl font-bold text-center truncate px-4">Interactive Quiz</h1>
            <button id="reset-btn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition flex items-center gap-2">
                <i data-lucide="rotate-ccw" class="w-4 h-4"></i> Reset
            </button>
        </div>

        <div id="quiz-container" class="w-full max-w-7xl mx-auto p-6 mt-16 h-full flex flex-col">
            <div class="flex-grow flex flex-col justify-center">
                 <h2 class="text-center text-slate-400 mb-8 font-light text-lg">Select a number to reveal a question</h2>
                 
                 <div id="number-grid" class="grid grid-cols-4 sm:grid-cols-6 md:grid-cols-8 lg:grid-cols-10 gap-3 md:gap-4 justify-content-center"></div>
            </div>
            
            <div id="main-controls" class="flex justify-center mt-8 pb-8">
                <button id="random-pick-btn" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 px-10 rounded-full text-xl shadow-lg shadow-blue-900/50 transform transition hover:-translate-y-1 active:translate-y-0 flex items-center gap-3">
                    <i data-lucide="shuffle" class="w-6 h-6"></i> Pick Random Question
                </button>
            </div>
        </div>

        <!-- Question Modal -->
        <div id="modal-overlay" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 hidden z-50 backdrop-blur-sm">
            <div id="modal" class="bg-white text-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-2xl text-center transform transition-all scale-100">
                <div class="flex justify-center mb-4">
                    <span id="modal-question-number" class="inline-block bg-blue-100 text-blue-800 text-sm font-bold px-3 py-1 rounded-full uppercase tracking-wide">Question</span>
                </div>
                
                <p id="modal-question-text" class="text-2xl md:text-3xl font-bold text-gray-800 mb-8 leading-tight"></p>
                
                <div id="modal-options-container" class="space-y-3 mb-8 text-left max-w-xl mx-auto"></div>
                
                <div id="modal-answer-box" class="hidden animate-fade-in bg-green-50 border-l-4 border-green-500 p-4 rounded-r mb-6 text-left">
                     <p class="text-sm text-green-600 font-bold uppercase mb-1">Correct Answer</p>
                     <p class="text-2xl font-bold text-green-800" id="modal-answer-text"></p>
                </div>
                
                <div id="modal-controls" class="flex justify-center gap-4">
                    <button id="modal-show-answer-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-8 rounded-xl shadow transition flex items-center gap-2">
                        <i data-lucide="eye" class="w-5 h-5"></i> Show Answer
                    </button>
                    <button id="modal-close-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-3 px-8 rounded-xl shadow transition">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Title Modal -->
    <div id="title-modal-overlay" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden z-[60]">
        <div id="title-modal" class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md">
            <h2 class="text-2xl font-bold text-center mb-2">Name Your Quiz</h2>
            <p class="text-center text-gray-500 mb-6 text-sm">Give your quiz a catchy title.</p>
            <input type="text" id="quiz-title-input" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none mb-1" placeholder="e.g., Solar System Facts">
            <p id="title-error-message" class="text-red-500 text-xs mt-1 hidden min-h-[1rem]">Title cannot be empty.</p>
            <div class="flex justify-end gap-3 mt-6">
                <button id="cancel-title-btn" class="text-gray-500 hover:text-gray-700 font-medium px-4 py-2">Cancel</button>
                <button id="save-title-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg shadow">Continue</button>
            </div>
        </div>
    </div>

    <!-- Format Info Modal -->
    <div id="format-info-modal-overlay" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden z-[60]">
        <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-lg">
            <h2 class="text-2xl font-bold mb-4">CSV Import Formats</h2>
            <div class="space-y-4 text-left">
                <div class="p-4 bg-gray-50 rounded-lg">
                    <h3 class="font-bold text-gray-800 mb-2">Identification</h3>
                    <p class="text-sm text-gray-600 mb-2">Use 2 columns (no headers):</p>
                    <div class="text-xs font-mono bg-white p-2 border rounded text-gray-500">
                        Who is the first US President?, George Washington<br>
                        Chemical symbol for Gold?, Au
                    </div>
                </div>
                <div class="p-4 bg-gray-50 rounded-lg">
                    <h3 class="font-bold text-gray-800 mb-2">Multiple Choice</h3>
                    <p class="text-sm text-gray-600 mb-2">Use 5 columns (Question, Correct Answer, 3 Wrong Options):</p>
                    <div class="text-xs font-mono bg-white p-2 border rounded text-gray-500">
                        Sky color?, Blue, Red, Green, Yellow<br>
                        2+2?, 4, 3, 5, 22
                    </div>
                </div>
            </div>
            <div class="flex justify-end mt-6">
                <button id="close-format-info-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg">Got it</button>
            </div>
        </div>
    </div>
    
    <!-- Question Count Modal -->
    <div id="question-count-modal-overlay" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden z-[60]">
        <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md">
            <h2 class="text-2xl font-bold text-center mb-2">How many questions?</h2>
            <p class="text-center text-gray-500 mb-6 text-sm">Enter the number of questions to generate.</p>
            <input type="number" id="question-count-input" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none mb-1" placeholder="e.g., 10" value="10" min="1" max="20">
            <div class="flex justify-end gap-3 mt-6">
                <button id="cancel-count-btn" class="text-gray-500 hover:text-gray-700 font-medium px-4 py-2">Cancel</button>
                <button id="generate-quiz-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg shadow">Generate</button>
            </div>
        </div>
    </div>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();
    </script>

    <script type="module">
        import { getGeminiApiKey } from './config.js';
        
        // --- Anti-Inspection Script ---
        // Disable Right Click
        document.addEventListener('contextmenu', event => event.preventDefault());

        // Disable Common Keyboard Shortcuts for Inspection
        document.onkeydown = function(e) {
            if(e.keyCode == 123) { // F12
                return false;
            }
            if(e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) { // Ctrl+Shift+I
                return false;
            }
            if(e.ctrlKey && e.shiftKey && e.keyCode == 'C'.charCodeAt(0)) { // Ctrl+Shift+C
                return false;
            }
            if(e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) { // Ctrl+Shift+J
                return false;
            }
            if(e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) { // Ctrl+U (View Source)
                return false;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Setup PDF.js worker
            if (window.pdfjsLib) {
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            }

            // --- Global State ---
            let currentUser = null;
            let currentQuizId = null;
            let currentQuizTitle = '';
            let quizData = [];
            let importType = 'identification';
            let pendingPdfText = '';
            
            // API key is now imported from config.js

            // --- Firebase Services ---
            const { auth, db, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, doc, setDoc, getDoc, addDoc, collection, getDocs, deleteDoc, updateDoc, query, where } = window.firebaseServices;

            // --- Page Elements ---
            const loadingOverlay = document.getElementById('loading-overlay');
            const loadingText = document.getElementById('loading-text');
            const authPage = document.getElementById('auth-page');
            const dashboardPage = document.getElementById('dashboard-page');
            const creationPage = document.getElementById('creation-page');
            const gamePage = document.getElementById('game-page');
            const allPages = [authPage, dashboardPage, creationPage, gamePage];
            const titleModalOverlay = document.getElementById('title-modal-overlay');
            const formatInfoModalOverlay = document.getElementById('format-info-modal-overlay');

            // --- Helpers ---
            const showLoading = (msg = "Loading...") => {
                loadingText.textContent = msg;
                loadingOverlay.classList.remove('hidden');
            };
            const hideLoading = () => loadingOverlay.classList.add('hidden');
            
            const showToast = (message, type = 'success') => {
                // Simple toast implementation could go here, for now using alert for errors
                if(type === 'error') alert(message);
            };

            // --- UI Navigation ---
            const showPage = (pageToShow) => {
                allPages.forEach(page => page.classList.add('hidden'));
                pageToShow.classList.remove('hidden');
                hideLoading();
                lucide.createIcons(); // Refresh icons
            };

            // --- Auth Logic ---
            const authError = document.getElementById('auth-error');
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    fetchUserQuizzes();
                    showPage(dashboardPage);
                } else {
                    currentUser = null;
                    showPage(authPage);
                }
            });

            document.getElementById('login-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                showLoading("Signing in...");
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    authError.textContent = '';
                } catch (error) {
                    authError.textContent = "Invalid email or password.";
                    hideLoading();
                }
            });

            document.getElementById('signup-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                showLoading("Creating account...");
                const email = document.getElementById('signup-email').value;
                const password = document.getElementById('signup-password').value;
                try {
                    await createUserWithEmailAndPassword(auth, email, password);
                    authError.textContent = '';
                } catch (error) {
                    authError.textContent = error.message;
                    hideLoading();
                }
            });

            document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
            document.getElementById('show-signup').addEventListener('click', (e) => { e.preventDefault(); document.getElementById('login-form').classList.add('hidden'); document.getElementById('signup-form').classList.remove('hidden'); });
            document.getElementById('show-login').addEventListener('click', (e) => { e.preventDefault(); document.getElementById('signup-form').classList.add('hidden'); document.getElementById('login-form').classList.remove('hidden'); });

            // --- Dashboard Logic ---
            const quizList = document.getElementById('quiz-list');
            const noQuizzesMessage = document.getElementById('no-quizzes-message');

            const fetchUserQuizzes = async () => {
                if (!currentUser) return;
                showLoading("Fetching quizzes...");
                quizList.innerHTML = '';
                const q = query(collection(db, "quizzes"), where("userId", "==", currentUser.uid));
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    noQuizzesMessage.classList.remove('hidden');
                } else {
                    noQuizzesMessage.classList.add('hidden');
                    querySnapshot.forEach((doc) => renderQuizCard(doc.id, doc.data()));
                }
                hideLoading();
                lucide.createIcons();
            };

            const renderQuizCard = (id, data) => {
                const card = document.createElement('div');
                card.className = 'bg-white p-6 rounded-xl shadow-sm hover:shadow-md transition border border-gray-100 flex flex-col h-full';
                const quizTitle = data.title || `Quiz with ${data.questions.length} questions`;
                // Calculate gradient based on title length hash for variety
                const colors = ['from-blue-500 to-cyan-400', 'from-purple-500 to-pink-500', 'from-emerald-500 to-teal-400', 'from-orange-500 to-amber-400'];
                const colorClass = colors[id.charCodeAt(0) % colors.length];

                card.innerHTML = `
                    <div class="flex items-start justify-between mb-4">
                        <div class="p-3 rounded-lg bg-gradient-to-br ${colorClass} text-white shadow-sm">
                            <i data-lucide="book-open" class="w-6 h-6"></i>
                        </div>
                        <div class="relative group">
                            <button data-id="${id}" class="delete-btn text-gray-400 hover:text-red-500 transition p-1">
                                <i data-lucide="trash-2" class="w-5 h-5 pointer-events-none"></i>
                            </button>
                        </div>
                    </div>
                    <h3 class="text-xl font-bold mb-2 text-gray-800 line-clamp-2">${quizTitle}</h3>
                    <p class="text-gray-500 text-sm mb-6 flex items-center gap-1">
                        <i data-lucide="help-circle" class="w-4 h-4"></i> ${data.questions.length} Questions
                    </p>
                    <div class="flex gap-3 mt-auto">
                        <button data-id="${id}" class="play-btn flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2.5 px-4 rounded-lg shadow-sm transition flex items-center justify-center gap-2">
                            <i data-lucide="play" class="w-4 h-4 pointer-events-none"></i> Play
                        </button>
                        <button data-id="${id}" class="edit-btn bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-2.5 px-4 rounded-lg border border-gray-200 transition">
                            Edit
                        </button>
                    </div>`;
                quizList.appendChild(card);
            };

            quizList.addEventListener('click', async (e) => {
                const target = e.target;
                const btn = target.closest('button');
                if (!btn) return;
                
                const quizId = btn.dataset.id;
                if (!quizId) return;

                if (btn.classList.contains('play-btn')) {
                    showLoading("Loading game...");
                    const quizDoc = await getDoc(doc(db, "quizzes", quizId));
                    if (quizDoc.exists()) {
                        const data = quizDoc.data();
                        quizData = data.questions.map((item, index) => ({ ...item, id: index + 1 }));
                        document.getElementById('game-title').textContent = data.title || 'Interactive Quiz';
                        initializeQuiz();
                        showPage(gamePage);
                    }
                } else if (btn.classList.contains('edit-btn')) {
                    showLoading("Loading editor...");
                    const quizDoc = await getDoc(doc(db, "quizzes", quizId));
                     if (quizDoc.exists()) {
                        currentQuizId = quizId;
                        const data = quizDoc.data();
                        currentQuizTitle = data.title || 'Your Quiz';
                        document.getElementById('creation-title').textContent = currentQuizTitle;
                        deleteAllQuestions();
                        data.questions.forEach(q => addQuestionField(q));
                        showPage(creationPage);
                    }
                } else if (btn.classList.contains('delete-btn')) {
                    if (confirm('Are you sure you want to delete this quiz?')) {
                        await deleteDoc(doc(db, "quizzes", quizId));
                        fetchUserQuizzes();
                    }
                }
            });
            
            // --- Title Modal Logic ---
            const quizTitleInput = document.getElementById('quiz-title-input');
            const titleErrorMessage = document.getElementById('title-error-message');

            document.getElementById('create-new-quiz-btn').addEventListener('click', () => {
                quizTitleInput.value = '';
                titleErrorMessage.classList.add('hidden');
                titleModalOverlay.classList.remove('hidden');
                quizTitleInput.focus();
            });

            document.getElementById('cancel-title-btn').addEventListener('click', () => {
                titleModalOverlay.classList.add('hidden');
            });

            document.getElementById('save-title-btn').addEventListener('click', () => {
                const newTitle = quizTitleInput.value.trim();
                if (newTitle) {
                    currentQuizId = null;
                    currentQuizTitle = newTitle;
                    document.getElementById('creation-title').textContent = currentQuizTitle;
                    deleteAllQuestions();
                    titleModalOverlay.classList.add('hidden');
                    showPage(creationPage);
                } else {
                    titleErrorMessage.classList.remove('hidden');
                }
            });

            quizTitleInput.addEventListener('input', () => {
                if (quizTitleInput.value.trim()) {
                    titleErrorMessage.classList.add('hidden');
                }
            });

            document.getElementById('back-to-dashboard-btn').addEventListener('click', () => showPage(dashboardPage));
            document.getElementById('game-back-to-dashboard-btn').addEventListener('click', () => showPage(dashboardPage));

            // --- Creation Page Logic ---
            const questionsContainer = document.getElementById('questions-container');
            const addQuestionBtn = document.getElementById('add-question-btn');
            const addQuestionBtnEmpty = document.getElementById('add-question-btn-empty');
            const saveQuizBtn = document.getElementById('save-quiz-btn');
            const emptyStateMessage = document.getElementById('empty-state-message');
            const fileUploadInput = document.getElementById('file-upload-input');
            const pdfUploadInput = document.getElementById('pdf-upload-input');
            let questionCount = 0;

            // --- Gemini PDF Logic ---
            const extractTextFromPDF = async (file) => {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: new Uint8Array(arrayBuffer) }).promise;
                let fullText = "";
                
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(" ");
                    fullText += pageText + "\n";
                }
                return fullText;
            };

            const generateQuizFromText = async (text, numQuestions = 10) => {
                const prompt = `
                Analyze the following text and generate ${numQuestions} quiz questions based on it. 
                Mix between 'identification' (simple Q&A) and 'multiple-choice' types.
                
                The output must be a valid JSON array of objects.
                Each object must have:
                - "type": either "identification" or "multiple-choice"
                - "question": string
                - "answer": string
                - "options": array of 4 strings (only required for multiple-choice, one must be the correct answer)

                Text to analyze:
                "${text.substring(0, 30000)}" 
                (Text truncated for limit)

                Output ONLY the raw JSON. No markdown code blocks, no "Here is the JSON".
                `;

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${getGeminiApiKey()}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }]
                        })
                    });

                    const data = await response.json();
                    
                    if (data.error) {
                        throw new Error(data.error.message || "API Error");
                    }

                    if (!data.candidates || data.candidates.length === 0) {
                        throw new Error("No response from AI");
                    }

                    let rawText = data.candidates[0].content.parts[0].text;
                    
                    // --- Fix: Robust JSON Extraction ---
                    // Find the first '[' and the last ']' to extract the JSON array
                    const startIndex = rawText.indexOf('[');
                    const endIndex = rawText.lastIndexOf(']');
                    
                    if (startIndex !== -1 && endIndex !== -1) {
                        rawText = rawText.substring(startIndex, endIndex + 1);
                    }
                    // -----------------------------------
                    
                    const questions = JSON.parse(rawText);
                    return questions;
                } catch (error) {
                    console.error("Gemini Error:", error);
                    throw new Error("Failed to generate quiz from AI: " + error.message);
                }
            };

            document.getElementById('import-pdf-btn').addEventListener('click', () => {
                pdfUploadInput.click();
            });

            // UPDATED: Handle Multiple PDFs
            pdfUploadInput.addEventListener('change', async (event) => {
                const files = Array.from(event.target.files);
                if (files.length === 0) return;

                try {
                    showLoading(`Reading ${files.length} PDF(s)...`);
                    
                    let combinedText = "";
                    for (const file of files) {
                        const text = await extractTextFromPDF(file);
                        combinedText += `\n--- Content from ${file.name} ---\n${text}`;
                    }
                    
                    if (!combinedText.trim()) {
                        throw new Error("No text found in PDF(s). Scanned PDFs (images) are not supported.");
                    }

                    hideLoading(); // Done reading, now ask user
                    pendingPdfText = combinedText;
                    document.getElementById('question-count-modal-overlay').classList.remove('hidden');

                } catch (error) {
                    hideLoading();
                    alert(error.message || "Error processing PDF");
                }
                event.target.value = '';
            });

            // New listeners for the question count modal
            document.getElementById('cancel-count-btn').addEventListener('click', () => {
                document.getElementById('question-count-modal-overlay').classList.add('hidden');
                pendingPdfText = '';
            });

            document.getElementById('generate-quiz-btn').addEventListener('click', async () => {
                 const countInput = document.getElementById('question-count-input');
                 const count = parseInt(countInput.value, 10) || 10;
                 
                 document.getElementById('question-count-modal-overlay').classList.add('hidden');
                 
                 if (!pendingPdfText) return;

                 try {
                    showLoading(`AI Generating ${count} Questions...`);
                    const generatedQuestions = await generateQuizFromText(pendingPdfText, count);
                    
                    deleteAllQuestions();
                    generatedQuestions.forEach(q => addQuestionField(q));
                    
                    hideLoading();
                 } catch (error) {
                    hideLoading();
                    alert(error.message || "Error generating quiz");
                 }
            });

            // --- CSV Import Logic ---
            document.getElementById('import-identification-btn').addEventListener('click', () => {
                importType = 'identification';
                fileUploadInput.click();
            });

            document.getElementById('import-multiple-choice-btn').addEventListener('click', () => {
                importType = 'multiple-choice';
                fileUploadInput.click();
            });
            
            document.getElementById('format-info-btn').addEventListener('click', () => formatInfoModalOverlay.classList.remove('hidden'));
            document.getElementById('close-format-info-btn').addEventListener('click', () => formatInfoModalOverlay.classList.add('hidden'));


            fileUploadInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const fileData = e.target.result;
                        const workbook = XLSX.read(fileData, { type: 'binary' });
                        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        
                        deleteAllQuestions();

                        if (importType === 'identification') {
                            jsonData.forEach(row => {
                                if (Array.isArray(row) && row.length >= 2 && String(row[0]).trim() && String(row[1]).trim()) {
                                    addQuestionField({
                                        type: 'identification',
                                        question: String(row[0]).trim(),
                                        answer: String(row[1]).trim()
                                    });
                                }
                            });
                        } else if (importType === 'multiple-choice') {
                             jsonData.forEach(row => {
                                if (Array.isArray(row) && row.length >= 3 && String(row[0]).trim() && String(row[1]).trim() && String(row[2]).trim()) {
                                    const question = String(row[0]).trim();
                                    const answer = String(row[1]).trim();
                                    const wrongOptions = row.slice(2).map(opt => String(opt).trim()).filter(opt => opt);
                                    
                                    if (wrongOptions.length < 1) return;

                                    const allOptions = [answer, ...wrongOptions].sort(() => Math.random() - 0.5);

                                    addQuestionField({
                                        type: 'multiple-choice',
                                        question: question,
                                        answer: answer,
                                        options: allOptions
                                    });
                                }
                            });
                        }

                    } catch (error) {
                        console.error("File processing error:", error);
                        alert("Error processing file. Please check the format.");
                    }
                };
                reader.readAsBinaryString(file);
                event.target.value = '';
            });

            const addQuestionField = (data = {}) => {
                const { type = 'identification', question = '', answer = '', options = ['', '', '', ''] } = data;
                emptyStateMessage.classList.add('hidden');
                questionCount++;
                const questionId = `q-${Date.now()}-${questionCount}`;
                const field = document.createElement('div');
                field.id = questionId;
                field.className = 'question-card bg-white p-6 rounded-xl shadow-sm border border-gray-100 relative transition hover:shadow-md';
                field.innerHTML = `
                    <div class="absolute top-4 right-4">
                        <button class="remove-question-btn text-gray-300 hover:text-red-500 transition">
                            <i data-lucide="trash-2" class="w-5 h-5 pointer-events-none"></i>
                        </button>
                    </div>
                    <div class="flex items-center gap-3 mb-4">
                        <div class="bg-blue-100 text-blue-700 font-bold w-8 h-8 flex items-center justify-center rounded-full text-sm question-number">
                            ${questionCount}
                        </div>
                        <select class="question-type-select p-2 border border-gray-300 rounded-lg text-sm bg-gray-50 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                            <option value="identification" ${type === 'identification' ? 'selected' : ''}>Identification</option>
                            <option value="multiple-choice" ${type === 'multiple-choice' ? 'selected' : ''}>Multiple Choice</option>
                        </select>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">Question</label>
                            <input type="text" placeholder="Enter your question here" class="question-input w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition" value="${question.replace(/"/g, '&quot;')}">
                        </div>
                        <div class="answer-section bg-gray-50 p-4 rounded-lg"></div>
                    </div>
                `;
                questionsContainer.appendChild(field);
                
                const answerSection = field.querySelector('.answer-section');
                const typeSelect = field.querySelector('.question-type-select');

                const renderAnswerSection = () => {
                    const selectedType = typeSelect.value;
                    if (selectedType === 'identification') {
                        answerSection.innerHTML = `
                            <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">Correct Answer</label>
                            <input type="text" placeholder="Enter the correct answer" class="answer-input w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:outline-none transition bg-white" value="${answer.replace(/"/g, '&quot;')}">
                        `;
                    } else {
                        // Ensure there are always 4 options for the UI
                        let displayOptions = [...options];
                        while(displayOptions.length < 4) displayOptions.push('');
                        if (displayOptions.length > 4) displayOptions = displayOptions.slice(0, 4);

                        answerSection.innerHTML = `
                             <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">Options (Select the correct one)</label>
                            <div class="space-y-3">
                                ${displayOptions.map((opt, i) => `
                                    <div class="flex items-center gap-3">
                                        <input type="radio" name="correct-answer-${questionId}" value="${i}" class="option-radio w-5 h-5 text-blue-600 focus:ring-blue-500" ${answer === opt && opt !== '' ? 'checked' : ''}>
                                        <input type="text" placeholder="Option ${i + 1}" class="option-input w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none bg-white text-sm" value="${opt.replace(/"/g, '&quot;') || ''}">
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    }
                };

                typeSelect.addEventListener('change', renderAnswerSection);
                field.querySelector('.remove-question-btn').addEventListener('click', (e) => {
                    field.remove();
                    updateQuestionNumbers();
                });

                renderAnswerSection();
                lucide.createIcons();
                
                // Scroll to new question
                field.scrollIntoView({ behavior: 'smooth', block: 'center' });
            };

            const updateQuestionNumbers = () => {
                const allFields = questionsContainer.querySelectorAll('.question-card');
                allFields.forEach((field, index) => {
                    field.querySelector('.question-number').textContent = index + 1;
                });
                questionCount = allFields.length;
                if (questionCount === 0) emptyStateMessage.classList.remove('hidden');
            };

            const deleteAllQuestions = () => {
                questionsContainer.innerHTML = '';
                questionsContainer.appendChild(emptyStateMessage);
                emptyStateMessage.classList.remove('hidden');
                updateQuestionNumbers();
            };

            addQuestionBtn.addEventListener('click', () => addQuestionField());
            addQuestionBtnEmpty.addEventListener('click', () => addQuestionField());

            saveQuizBtn.addEventListener('click', async () => {
                let validQuestions = [];
                const questionFields = questionsContainer.querySelectorAll('.question-card');

                questionFields.forEach(field => {
                    const type = field.querySelector('.question-type-select').value;
                    const question = field.querySelector('.question-input').value.trim();
                    let answer = '';
                    let options = [];
                    let isValid = false;

                    if (type === 'identification') {
                        answer = field.querySelector('.answer-input').value.trim();
                        if (question && answer) isValid = true;
                    } else {
                        const optionInputs = Array.from(field.querySelectorAll('.option-input'));
                        const radioButtons = Array.from(field.querySelectorAll('.option-radio'));
                        const checkedRadio = radioButtons.find(rb => rb.checked);
                        
                        options = optionInputs.map(input => input.value.trim()).filter(opt => opt);
                        if (checkedRadio) {
                            answer = optionInputs[checkedRadio.value].value.trim();
                        }

                        if (question && answer && options.length > 1 && options.includes(answer)) {
                             isValid = true;
                        }
                    }

                    if (isValid) {
                        validQuestions.push({ type, question, answer, options });
                    }
                });

                if (validQuestions.length < 1) {
                    alert("Please complete at least 1 valid question.");
                    return;
                }
                
                const quizPayload = {
                    userId: currentUser.uid,
                    title: currentQuizTitle,
                    questions: validQuestions,
                    updatedAt: new Date()
                };

                showLoading("Saving quiz...");
                try {
                    if (currentQuizId) {
                        await updateDoc(doc(db, "quizzes", currentQuizId), quizPayload);
                    } else {
                        quizPayload.createdAt = new Date();
                        await addDoc(collection(db, "quizzes"), quizPayload);
                    }
                    fetchUserQuizzes();
                    showPage(dashboardPage);
                } catch (error) {
                    hideLoading();
                    alert("Could not save quiz. " + error.message);
                }
            });

            // --- Game Page Logic ---
            const numberGrid = document.getElementById('number-grid');
            const randomPickBtn = document.getElementById('random-pick-btn');
            const resetBtn = document.getElementById('reset-btn');
            const modalOverlay = document.getElementById('modal-overlay');
            const modalQuestionNumber = document.getElementById('modal-question-number');
            const modalQuestionText = document.getElementById('modal-question-text');
            const modalOptionsContainer = document.getElementById('modal-options-container');
            const modalAnswerBox = document.getElementById('modal-answer-box');
            const modalAnswerText = document.getElementById('modal-answer-text');
            const modalShowAnswerBtn = document.getElementById('modal-show-answer-btn');
            const modalCloseBtn = document.getElementById('modal-close-btn');

            let currentQuestionData = {};
            let availableQuestionIds = [];

            const initializeQuiz = () => {
                numberGrid.innerHTML = '';
                availableQuestionIds = quizData.map(q => q.id);
                randomPickBtn.innerHTML = '<i data-lucide="shuffle" class="w-6 h-6"></i> Pick Random Question';
                randomPickBtn.disabled = false;
                randomPickBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                document.getElementById('confetti-container').innerHTML = '';

                quizData.forEach(q => {
                    const box = document.createElement('div');
                    box.className = 'number-box bg-slate-700 text-white rounded-xl aspect-square flex items-center justify-center text-2xl md:text-3xl font-bold cursor-pointer transition-all hover:bg-blue-600 hover:scale-105 shadow-lg border border-slate-600';
                    box.textContent = q.id;
                    box.dataset.id = q.id;
                    numberGrid.appendChild(box);
                });
                lucide.createIcons();
            };

            const displayQuestion = (id) => {
                currentQuestionData = quizData.find(q => q.id === id);
                if (!currentQuestionData) return;

                const box = numberGrid.querySelector(`.number-box[data-id='${id}']`);
                if (box.classList.contains('visited')) return;

                modalQuestionNumber.textContent = `Question #${currentQuestionData.id}`;
                modalQuestionText.textContent = currentQuestionData.question;
                modalOptionsContainer.innerHTML = '';

                if (currentQuestionData.type === 'multiple-choice') {
                    const shuffledOptions = [...currentQuestionData.options].sort(() => Math.random() - 0.5);
                    shuffledOptions.forEach(option => {
                        const optionEl = document.createElement('div');
                        optionEl.className = 'border-2 border-slate-100 p-4 rounded-xl text-lg hover:border-blue-200 hover:bg-blue-50 transition cursor-pointer font-medium text-slate-700';
                        optionEl.textContent = option;
                        optionEl.onclick = () => {
                            // Visual feedback for clicking an option (optional interaction)
                            document.querySelectorAll('#modal-options-container div').forEach(d => d.className = 'border-2 border-slate-100 p-4 rounded-xl text-lg text-slate-400');
                            optionEl.className = 'border-2 border-blue-500 bg-blue-50 p-4 rounded-xl text-lg font-bold text-blue-800';
                        }
                        modalOptionsContainer.appendChild(optionEl);
                    });
                } else {
                    const hint = document.createElement('p');
                    hint.className = "text-gray-400 italic text-sm";
                    hint.textContent = "(Identification - Think of the answer!)";
                    modalOptionsContainer.appendChild(hint);
                }

                modalAnswerBox.classList.add('hidden');
                modalShowAnswerBtn.classList.remove('hidden');
                modalOverlay.classList.remove('hidden');

                box.classList.add('visited');
                box.classList.remove('bg-slate-700', 'hover:bg-blue-600');
                const index = availableQuestionIds.indexOf(id);
                if (index > -1) availableQuestionIds.splice(index, 1);

                if (availableQuestionIds.length === 0) {
                    randomPickBtn.innerHTML = '<i data-lucide="trophy" class="w-6 h-6"></i> Quiz Complete!';
                    randomPickBtn.disabled = true;
                    randomPickBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    launchConfetti();
                }
                lucide.createIcons();
            };
            
            const startRandomAnimation = () => {
                const availableBoxes = Array.from(numberGrid.querySelectorAll('.number-box:not(.visited)'));
                if (availableBoxes.length === 0) return;

                randomPickBtn.disabled = true;
                const duration = 1500;
                const interval = 100;
                let lastBox = null;

                const animation = setInterval(() => {
                    if (lastBox) lastBox.classList.remove('random-active', 'bg-blue-500');
                    const randomBox = availableBoxes[Math.floor(Math.random() * availableBoxes.length)];
                    randomBox.classList.add('random-active', 'bg-blue-500');
                    lastBox = randomBox;
                }, interval);

                setTimeout(() => {
                    clearInterval(animation);
                    if (lastBox) {
                        lastBox.classList.remove('random-active', 'bg-blue-500');
                        displayQuestion(parseInt(lastBox.dataset.id));
                    }
                    if (availableQuestionIds.length > 0) randomPickBtn.disabled = false;
                }, duration);
            };

            const closeModal = () => modalOverlay.classList.add('hidden');

            const launchConfetti = () => {
                const container = document.getElementById('confetti-container');
                container.innerHTML = '';
                const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'];
                for (let i = 0; i < 150; i++) {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + 'vw';
                    confetti.style.animationDuration = Math.random() * 3 + 2 + 's';
                    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    container.appendChild(confetti);
                }
            };

            numberGrid.addEventListener('click', (e) => {
                if (e.target.classList.contains('number-box')) {
                    displayQuestion(parseInt(e.target.dataset.id));
                }
            });

            modalShowAnswerBtn.addEventListener('click', () => {
                modalAnswerText.textContent = currentQuestionData.answer;
                modalAnswerBox.classList.remove('hidden');
                modalShowAnswerBtn.classList.add('hidden');
            });

            modalCloseBtn.addEventListener('click', closeModal);
            modalOverlay.addEventListener('click', (e) => {
                if (e.target === modalOverlay) closeModal();
            });

            randomPickBtn.addEventListener('click', startRandomAnimation);
            resetBtn.addEventListener('click', initializeQuiz);
        });
    </script>
</body>
</html>